#Windows伺服器環境規劃建置 #FTP

FTP 的意思是 File Transffer Protocal，檔案傳輸協定~

# 傳輸模式有分 2 種
## 主動式 (Port 模式)
![](../img/Pasted%20image%2020201026135840.png)
1. 提出連線要求，並告知 (M + 1) port
註： M > 1024
2. 回應要求
3. SVR 主動連到 (M + 1) port
4. 建立連線，開始傳輸資料

註：21, M 埠是控制通道，20, M+1 埠是資料傳輸通道

## 被動式 (PASV模式)
![](../img/Pasted%20image%2020201026140443.png)
1. 提出連線要求，送出被動式要求連線 (PASV)
2. 回應要求，並告知 P
註： P 一樣要 > 1024
3. SVR 被動等待 CLT 連線
5. 建立連線，開始傳輸資料

## 兩者的比較
主動式，在 CLT 端要開 port 讓 SVR 連線，這會造成資安的風險

# 安裝流程
## 安裝 FTP SVR 服務
1. 新增角色及功能 > 網頁伺服器 > FTP 伺服器
![](../img/Pasted%20image%2020201026141222.png)![](../img/Pasted%20image%2020201026141305.png)![](../img/Pasted%20image%2020201026141350.png)
2. 安裝完畢之後預設會在 C:/inetpub/ 下建立 ftproot 的資料夾![](../img/Pasted%20image%2020201026141537.png)

## 建立 FTP 站台
1. 到 IIS 管理員 > 站台 > 新增 FTP 站台 來建立 FTP 站吧！![](../img/Pasted%20image%2020201026145422.png)
2. 先完成 FTP 的基本設定![](../img/Pasted%20image%2020201026150009.png)![](../img/Pasted%20image%2020201026150304.png)![](../img/Pasted%20image%2020201026150414.png)FTP 站台出來囉~~![](../img/Pasted%20image%2020201026150736.png)
3. **這裡有個坑**，FTP 站台需要把主機重開機才會運作喔~~

## CLT 主動模式連線
1. 填上要連線的 FTP 站台 IP 並登入，這裡示範用*匿名*![](../img/Pasted%20image%2020201026151123.png)
2. 設定為**主動模式**![](../img/Pasted%20image%2020201026151309.png)
3. 顯示詳細日誌才能看到細節![](../img/Pasted%20image%2020201026151551.png)
4. 大驚！防火牆怎麼啟動了？！冷靜點，想想主動模式的流程，原來是第 3 步 SVR 要連線來 CLT 端了啦！![](../img/Pasted%20image%2020201026151732.png)允許存取以後會在防火牆的設定裡同意 FileZilla 軟體翻牆吔![](../img/Pasted%20image%2020201026155910.png)
5. 藍色是指令、綠色是回應訊息![](../img/Pasted%20image%2020201026151927.png)看到 PORT 主動模式了吧！話說 IP 後面的 192,62 是什麼鬼？！說好的埠號 > 1024 呢？年輕人，它是要解碼的~格式是(A \* 256 + B) ，套到這裡就是 192 \* 256 + 62，所以是 49214

## CLT 被動模式連線
1. 跟上面一樣填入 FTP 站台連線的資訊，不同的是把傳輸模式設為**被動模式**![](../img/Pasted%20image%2020201026155103.png)
2. 來找找 log 不一樣的地方吧！![](../img/Pasted%20image%2020201026155345.png)這裡 SRV 端回傳的 P port 解碼方法跟 M port 一樣喔！！

做到這裡，不禁要想想看，難道 SRV 這樣讓 CLT 一直開 port 好嗎？！我們試試把它限制在一定的範圍，來增加安全性

## 設定被動模式連線資料通道的連接埠範圍
1. 從 FTP 站台 >  FTP 防火牆支援，就可以設定囉！![](../img/Pasted%20image%2020201026160748.png)
2. 設定範圍，這裡示範設在 5400 - 5500 之間![](../img/Pasted%20image%2020201026160857.png)
3. 別忘了 FTP 的槽點，重新開機![](../img/Pasted%20image%2020201026161007.png)
4. 這次的 log 哪裡長得不一樣![](../img/Pasted%20image%2020201026161323.png)來算一下 21 \* 256 + 24 = 5400 ，真的有吔！

接下來，我們就來[[Windows Server/FTP練習]]一下吧！

## 磁碟配額設定
1. 先新增伺服器角色，到**檔案和存放服務 > 檔案和 iSCSI 服務 > 檔案伺服器資源管理員**![](../img/Pasted%20image%2020201029155511.png)
2. 工具內就會多出**檔案伺服器資源管理員**![](../img/Pasted%20image%2020201029160121.png)
3. 到**檔案伺服器資源管理員 > 配額管理 > 配額 > 建立配額**![](../img/Pasted%20image%2020201029160351.png)
4. 建立配額的設定![](../img/Pasted%20image%2020201029161123.png)
5. 閥值指得是可以設定使用者配額用到多少容量時，會做什麼通知![](../img/Pasted%20image%2020201029161252.png)
6. 測試看看是不是真的只有 5 MB 可以用；還真的被擋了！！！![](../img/Pasted%20image%2020201029161527.png)
7. 停用的話是不是真的可以解除封印呢？![](../img/Pasted%20image%2020201029161709.png)成功上傳囉![](../img/Pasted%20image%2020201029161836.png)